#!/usr/bin/python
import subprocess
import glob
import os

# Check for malware, as per https://support.apple.com/en-us/ht203987

syswide_baddies = [
    '/System/Library/Frameworks/v.framework',
    '/System/Library/Frameworks/VSearch.framework',
    '/Library/PrivilegedHelperTools/Jack',
    '/Library/InputManagers/CTLoader/',
    '/Library/Application Support/Conduit/',
    '/Applications/SearchProtect.app',
    '/private/etc/launchd.conf',
    '/Applications/Genieo',
    '/Applications/InstallMac',
    '/Applications/Uninstall Genieo',
    '/Applications/Uninstall IM Completer.app',
    '/usr/lib/libgenkit.dylib',
    '/usr/lib/libgenkitsa.dylib',
    '/usr/lib/libimckit.dylib',
    '/usr/lib/libimckitsa.dylib',
    '/Library/PrivilegedHelperTools/com.genieoinnovation.macextension.client',
    '/Library/Frameworks/GenieoExtra.framework',
    '/Library/LaunchAgents/com.genieo.completer.update.plist',
    '/Library/LaunchAgents/com.genieo.engine.plist',
    '/Library/LaunchAgents/com.genieoinnovation.macextension.client.plist',
    '/Library/LaunchAgents/com.genieoinnovation.macextension.plist',
    '/Library/LaunchDaemons/com.genieoinnovation.macextension.client.plist',
    '/Library/LaunchDaemons/Jack.plist'
    ]

per_user_baddies = [
    '/Users/*/Library/Internet Plug-Ins/ConduitNPAPIPlugin.plugin',
    '/Users/*/Library/Internet Plug-Ins/TroviNPAPIPlugin.plugin',
    '/Users/*/Library/Application Support/Genieo/',
    '/Users/*/Library/Application Support/com.genieoinnovation.Installer/',
    '/Users/*/Conduit/',
    '/Users/*/Trovi/',
    '/Users/*/Library/Caches/com.Conduit.takeOverSearchAssetsMac',
    '/Users/*/Library/Caches/com.VSearch.bulk.installer',
    '/Users/*/Library/Caches/com.VSearch.VSinstaller',
    '/Users/*/Library/LaunchAgents/clipboardd',
    '/Users/*/Library/LaunchAgents/com.apple.service.clipboardd.plist',
    '/Users/*/Library/LaunchAgents/com.genieo.completer.download.plist',
    '/Users/*/Library/LaunchAgents/com.genieo.completer.ltvbit.plist',
    '/Users/*/Library/LaunchAgents/com.genieo.completer.update.plist',
    '/Users/*/Library/LaunchAgents/com.jdibackup.ZipCloud.autostart.plist',
    '/Users/*/Library/LaunchAgents/com.zeobit.MacKeeper.Helper.plist',
    '/Users/*/Library/Preferences/com.genieo.global.settings.plist.lockfile',
    '/Users/*/Library/Preferences/com.geneio.settings.plist.lockfile',
    '/Users/*/Library/Preferences/com.geneio.global.settings.plist',
    '/Users/*/Library/Saved Application State/com.genieo.RemoveGenieoMac.savedState',
    '/Users/*/Library/Saved Application State/com.VSearch.bulk.installer.savedstate',
    '/Users/*/.fontset'
]

SUSPECTS = []
for sysbad in syswide_baddies:
    if os.path.exists(sysbad):
        SUSPECTS.append(sysbad)

for usrbad in per_user_baddies:
    globber = glob.glob(usrbad)
    for blob in globber:
        if os.path.exists(blob):
            SUSPECTS.append(blob)

KNOWN_MALWARE_PATH = ''
for caught in SUSPECTS:
    KNOWN_MALWARE_PATH += "Known malware exists at %s\n" % caught

if not KNOWN_MALWARE_PATH == '':
    print('<result>' + KNOWN_MALWARE_PATH + '</result>')
else:
    print('<result>Clean</result>')
